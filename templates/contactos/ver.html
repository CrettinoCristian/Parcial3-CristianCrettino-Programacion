{% extends "base.html" %}

{% block title %}{{ contacto.nombre }} - Mini CRM Personal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Información del contacto -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-person-circle"></i> {{ contacto.nombre }}
                </h4>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('contactos.editar', id=contacto.id) }}" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-pencil"></i> Editar
                    </a>
                    <a href="{{ url_for('interacciones.nueva', contacto_id=contacto.id) }}" 
                       class="btn btn-success btn-sm">
                        <i class="bi bi-chat-dots"></i> Nueva Interacción
                    </a>
                </div>
            </div>
            
            <div class="card-body">
                <div class="row">
                    <!-- Información de contacto -->
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-person"></i> Información de Contacto
                        </h6>
                        
                        {% if contacto.email %}
                            <p class="mb-2">
                                <i class="bi bi-envelope text-muted"></i>
                                <a href="mailto:{{ contacto.email }}" class="text-decoration-none ms-2">
                                    {{ contacto.email }}
                                </a>
                            </p>
                        {% endif %}
                        
                        {% if contacto.telefono %}
                            <p class="mb-2">
                                <i class="bi bi-telephone text-muted"></i>
                                <a href="tel:{{ contacto.telefono }}" class="text-decoration-none ms-2">
                                    {{ contacto.telefono }}
                                </a>
                            </p>
                        {% endif %}
                        
                        {% if contacto.empresa %}
                            <p class="mb-2">
                                <i class="bi bi-building text-muted"></i>
                                <span class="ms-2">{{ contacto.empresa }}</span>
                            </p>
                        {% endif %}
                    </div>
                    
                    <!-- Metadatos -->
                    <div class="col-md-6">
                        <h6 class="text-success mb-3">
                            <i class="bi bi-info-circle"></i> Información del Sistema
                        </h6>
                        
                        <p class="mb-2">
                            <i class="bi bi-calendar-plus text-muted"></i>
                            <span class="ms-2">
                                <strong>Creado:</strong> {{ contacto.fecha_creacion.strftime('%d/%m/%Y %H:%M') }}
                            </span>
                        </p>
                        
                        <p class="mb-2">
                            <i class="bi bi-calendar-check text-muted"></i>
                            <span class="ms-2">
                                <strong>Actualizado:</strong> {{ contacto.fecha_actualizacion.strftime('%d/%m/%Y %H:%M') }}
                            </span>
                        </p>
                        
                        <p class="mb-2">
                            <i class="bi bi-clock text-muted"></i>
                            <span class="ms-2">
                                <strong>Última interacción:</strong> {{ contacto.ultima_interaccion.strftime('%d/%m/%Y') }}
                            </span>
                        </p>
                        
                        <p class="mb-2">
                            <i class="bi bi-chat-dots text-muted"></i>
                            <span class="ms-2">
                                <strong>Total interacciones:</strong> {{ contacto.interacciones|length }}
                            </span>
                        </p>
                    </div>
                </div>
                
                <!-- Etiquetas -->
                {% if contacto.get_etiquetas_list() %}
                    <div class="mt-3">
                        <h6 class="text-info mb-2">
                            <i class="bi bi-tags"></i> Etiquetas
                        </h6>
                        <div>
                            {% for etiqueta in contacto.get_etiquetas_list() %}
                                <span class="badge bg-secondary me-1 mb-1">{{ etiqueta }}</span>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                
                <!-- Notas -->
                {% if contacto.notas %}
                    <div class="mt-3">
                        <h6 class="text-warning mb-2">
                            <i class="bi bi-journal-text"></i> Notas
                        </h6>
                        <div class="bg-secondary text-light p-3 rounded">
                            <p class="mb-0">{{ contacto.notas|nl2br|safe }}</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Últimas interacciones -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-chat-dots"></i> Últimas Interacciones
                </h5>
                <a href="{{ url_for('interacciones.listar', contacto_id=contacto.id) }}" 
                   class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-list"></i> Ver Todas
                </a>
            </div>
            
            <div class="card-body">
                {% if interacciones %}
                    {% for interaccion in interacciones %}
                        <div class="border-start border-primary border-3 ps-3 mb-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <p class="mb-1">{{ interaccion.nota }}</p>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar"></i> 
                                        {{ interaccion.fecha.strftime('%d/%m/%Y %H:%M') }}
                                        <span class="tiempo-transcurrido ms-2" data-fecha="{{ interaccion.fecha.isoformat() }}">
                                            Calculando...
                                        </span>
                                    </small>
                                </div>
                                <div class="ms-2">
                                    <a href="{{ url_for('interacciones.ver', id=interaccion.id) }}" 
                                       class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    
                    {% if contacto.interacciones|length > 5 %}
                        <div class="text-center">
                            <a href="{{ url_for('interacciones.listar', contacto_id=contacto.id) }}" 
                               class="btn btn-outline-primary">
                                Ver las {{ contacto.interacciones|length - 5 }} interacciones restantes
                            </a>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-chat-x text-muted" style="font-size: 2rem;"></i>
                        <p class="text-muted mt-2 mb-3">No hay interacciones registradas</p>
                        <a href="{{ url_for('interacciones.nueva', contacto_id=contacto.id) }}" 
                           class="btn btn-success">
                            <i class="bi bi-chat-dots"></i> Agregar Primera Interacción
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Sidebar con acciones -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-lightning"></i> Acciones Rápidas
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('contactos.editar', id=contacto.id) }}" 
                       class="btn btn-outline-primary">
                        <i class="bi bi-pencil"></i> Editar Contacto
                    </a>
                    
                    <a href="{{ url_for('interacciones.nueva', contacto_id=contacto.id) }}" 
                       class="btn btn-success">
                        <i class="bi bi-chat-dots"></i> Nueva Interacción
                    </a>
                    
                    <a href="{{ url_for('interacciones.listar', contacto_id=contacto.id) }}" 
                       class="btn btn-outline-info">
                        <i class="bi bi-list"></i> Ver Todas las Interacciones
                    </a>
                    
                    {% if contacto.email %}
                        <a href="mailto:{{ contacto.email }}" 
                           class="btn btn-outline-secondary">
                            <i class="bi bi-envelope"></i> Enviar Email
                        </a>
                    {% endif %}
                    
                    {% if contacto.telefono %}
                        <a href="tel:{{ contacto.telefono }}" 
                           class="btn btn-outline-secondary">
                            <i class="bi bi-telephone"></i> Llamar
                        </a>
                    {% endif %}
                    
                    <hr>
                    
                    <form method="POST" 
                          action="{{ url_for('contactos.eliminar', id=contacto.id) }}"
                          onsubmit="return confirm('¿Estás seguro de eliminar este contacto? Esta acción no se puede deshacer.');"
                          class="d-inline">
                        <button type="submit" class="btn btn-outline-danger w-100">
                            <i class="bi bi-trash"></i> Eliminar Contacto
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Navegación -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-compass"></i> Navegación
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('contactos.listar') }}" 
                       class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> Volver a Contactos
                    </a>
                    
                    <a href="{{ url_for('main.dashboard') }}" 
                       class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-speedometer2"></i> Ir al Dashboard
                    </a>
                    
                    <a href="{{ url_for('contactos.nuevo') }}" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-person-plus"></i> Nuevo Contacto
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Función para copiar información al portapapeles
    function copiarAlPortapapeles(texto, elemento) {
        navigator.clipboard.writeText(texto).then(function() {
            // Mostrar feedback visual
            const originalText = elemento.innerHTML;
            elemento.innerHTML = '<i class="bi bi-check"></i> Copiado';
            elemento.classList.add('text-success');
            
            setTimeout(function() {
                elemento.innerHTML = originalText;
                elemento.classList.remove('text-success');
            }, 2000);
        });
    }

    function calcularTiempoTranscurrido() {
        const elementos = document.querySelectorAll('.tiempo-transcurrido');
        elementos.forEach(elemento => {
            const fecha = new Date(elemento.dataset.fecha);
            const ahora = new Date();
            const diferencia = ahora - fecha;
            const totalMinutos = Math.abs(diferencia) / (1000 * 60);
            const totalHoras = Math.floor(totalMinutos / 60);
            const dias = Math.floor(totalHoras / 24);
            const horasRestantes = totalHoras % 24;
            
            let texto = '';
            
            // Si la fecha es futura
            if (diferencia < 0) {
                if (totalMinutos < 60) {
                    texto = `(en ${Math.floor(totalMinutos)} min)`;
                } else if (totalHoras < 24) {
                    texto = `(faltan ${totalHoras} hora${totalHoras > 1 ? 's' : ''})`;
                } else if (dias === 1 && horasRestantes === 0) {
                    texto = '(mañana)';
                } else if (dias === 1) {
                    texto = `(mañana, ${horasRestantes}h)`;
                } else if (dias < 7) {
                    if (horasRestantes === 0) {
                        texto = `(en ${dias} día${dias > 1 ? 's' : ''})`;
                    } else {
                        texto = `(en ${dias}d ${horasRestantes}h)`;
                    }
                } else if (dias < 30) {
                    const semanas = Math.floor(dias / 7);
                    texto = `(en ${semanas} sem)`;
                } else {
                    const meses = Math.floor(dias / 30);
                    texto = `(en ${meses} mes${meses > 1 ? 'es' : ''})`;
                }
            } else {
                // Si la fecha es pasada
                if (totalMinutos < 60) {
                    texto = `(hace ${Math.floor(totalMinutos)} min)`;
                } else if (totalHoras < 24) {
                    texto = `(hace ${totalHoras} hora${totalHoras > 1 ? 's' : ''})`;
                } else if (dias === 1 && horasRestantes === 0) {
                    texto = '(ayer)';
                } else if (dias === 1) {
                    texto = `(ayer, ${horasRestantes}h)`;
                } else if (dias < 7) {
                    if (horasRestantes === 0) {
                        texto = `(hace ${dias} día${dias > 1 ? 's' : ''})`;
                    } else {
                        texto = `(hace ${dias}d ${horasRestantes}h)`;
                    }
                } else if (dias < 30) {
                    const semanas = Math.floor(dias / 7);
                    texto = `(hace ${semanas} sem)`;
                } else {
                    const meses = Math.floor(dias / 30);
                    texto = `(hace ${meses} mes${meses > 1 ? 'es' : ''})`;
                }
            }
            
            elemento.textContent = texto;
        });
    }

    document.addEventListener('DOMContentLoaded', calcularTiempoTranscurrido);
</script>
{% endblock %}